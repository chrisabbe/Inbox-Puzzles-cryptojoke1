<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Cryptogram ‚Äî AutoSave Demo</title>
</head>
<body style="font-family:monospace;">
  <div style="max-width:720px;margin:1rem auto;padding:1em;background:#fafafa;border-radius:12px;border:1px solid #ccc;">
    <h3 style="text-align:center;margin-top:0;">üîê Cryptogram Puzzle</h3>
    <p id="note" style="text-align:center;font-style:italic;margin-bottom:1em;">
      Each letter stands for another. Type your guess below each letter ‚Äî your progress is saved automatically!
    </p>

    <div id="cryptogram" style="display:flex;flex-direction:column;align-items:center;gap:10px;font-size:18px;line-height:1.4;margin-bottom:1em;"></div>

    <div style="text-align:center;">
      <button id="resetButton" style="padding:6px 12px;border:1px solid #bbb;border-radius:6px;background:#eee;cursor:pointer;font-family:inherit;font-size:15px;">üîÑ Clear My Answers</button>
    </div>
    <div id="status" style="text-align:center;margin-top:8px;color:#666;font-size:13px;"></div>
  </div>

<script>
(function(){
  // CONFIG
  const phrase = "FSW ROR DST CZQNTZNLF FOH QH QFQNR? MTZQACT ST FQC LADCDQHROHP OH SOC YOTIR.";
  const STORAGE_KEY = "cryptogram_progress_scarecrow_v3";

  // DOM REFS
  const container = document.getElementById('cryptogram');
  const resetButton = document.getElementById('resetButton');
  const status = document.getElementById('status');
  const note = document.getElementById('note');

  // Helpers: detect localStorage availability
  function localStorageAvailable() {
    try {
      const testKey = '__ls_test__';
      window.localStorage.setItem(testKey, '1');
      window.localStorage.removeItem(testKey);
      return true;
    } catch (e) {
      return false;
    }
  }

  const canUseLocalStorage = localStorageAvailable();

  // Load saved progress safely
  let saved = {};
  if (canUseLocalStorage) {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) saved = JSON.parse(raw) || {};
    } catch (err) {
      console.warn("Could not parse saved progress ‚Äî starting fresh.", err);
      // fallback to empty saved object and overwrite bad data on first save
      saved = {};
    }
  } else {
    // show a small note if localStorage isn't available (likely in email clients)
    note.textContent = "Note: this environment does not allow saving (some email clients block JavaScript). Try opening this page in a normal browser to enable auto-save.";
    status.textContent = "Auto-save unavailable in this environment.";
  }

  // Build puzzle with words grouped (no mid-word wrapping)
  phrase.split(' ').forEach((word, wIndex) => {
    const wordDiv = document.createElement('div');
    wordDiv.style.display = "inline-flex";
    wordDiv.style.marginRight = "12px";
    wordDiv.style.flexWrap = "nowrap";
    wordDiv.style.alignItems = "flex-end";

    word.split('').forEach((ch, cIndex) => {
      if (/[A-Z]/.test(ch)) {
        const cell = document.createElement('div');
        cell.style.display = "flex";
        cell.style.flexDirection = "column";
        cell.style.alignItems = "center";
        cell.style.width = "1.6em";

        const top = document.createElement('div');
        top.textContent = ch;
        top.style.fontWeight = "bold";
        top.style.marginBottom = "4px";

        const box = document.createElement('input');
        box.type = "text";
        box.maxLength = 1;
        box.style.width = "1.6em";
        box.style.textAlign = "center";
        box.style.textTransform = "uppercase";
        box.style.border = "1px solid #bbb";
        box.style.borderRadius = "4px";
        box.style.padding = "3px";
        box.autocomplete = "off";

        const id = `${wIndex}-${cIndex}`;
        // restore value if present
        if (saved[id]) box.value = saved[id];

        // each input knows its id for saving
        box.dataset.saveId = id;

        box.addEventListener('input', e => {
          e.target.value = e.target.value.toUpperCase();
          // update saved only if localStorage available
          if (canUseLocalStorage) {
            saved[id] = e.target.value;
            try {
              localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
              status.textContent = "Progress saved locally.";
              // clear status message after short delay
              setTimeout(()=> { status.textContent = ""; }, 900);
            } catch (err) {
              console.error("Failed to save progress:", err);
              status.textContent = "Failed to save progress.";
            }
          } else {
            status.textContent = "Auto-save unavailable in this environment.";
          }
        });

        cell.appendChild(top);
        cell.appendChild(box);
        wordDiv.appendChild(cell);
      } else {
        // punctuation or other character inside word
        const punct = document.createElement('div');
        punct.textContent = ch;
        punct.style.marginLeft = "6px";
        punct.style.fontWeight = "bold";
        punct.style.lineHeight = "1.6";
        wordDiv.appendChild(punct);
      }
    });

    container.appendChild(wordDiv);
  });

  // Reset / clear function
  function clearAllAnswers(confirmFirst = true) {
    const doClear = !confirmFirst || (typeof window.confirm === 'function' ? window.confirm("Are you sure you want to clear all your answers?") : true);
    if (!doClear) return;
    // clear storage
    if (canUseLocalStorage) {
      try {
        localStorage.removeItem(STORAGE_KEY);
        saved = {};
      } catch (err) {
        console.error("Failed to clear localStorage:", err);
      }
    }
    // clear inputs
    container.querySelectorAll('input').forEach(input => input.value = '');
    status.textContent = "Answers cleared.";
    setTimeout(()=> { status.textContent = ""; }, 1500);
  }

  resetButton.addEventListener('click', () => clearAllAnswers(true));

  // Expose for debugging (optional)
  window.__cryptogramDebug = {
    STORAGE_KEY,
    canUseLocalStorage,
    saved,
    clearAllAnswers
  };

  // If localStorage was not available, print a console note
  if (!canUseLocalStorage) {
    console.info("localStorage unavailable. Auto-save disabled. This is expected in many email clients.");
  }
})();
</script>
</body>
</html>
